<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Quiz Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#fff; --muted:#6b7280; --line:#e5e7eb;
      --brand:#7a1d3c; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body { font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
           padding: 20px; max-width: 1200px; margin: auto; color:#111; background:#fff; }
    h1{margin:0 0 14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .btn{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
    .btn.small{padding:6px 9px;font-size:12px}
    input,select,textarea{
      padding:10px;border:1px solid var(--line);border-radius:10px;min-width:0;
      width:100%;
    }
    .section{margin-top:22px}
    .q-card{border:1px solid var(--line);border-radius:12px;padding:14px 14px 10px;margin:14px 0;background:#fafafa}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .opt-row{display:grid;grid-template-columns: 1.1fr 1fr 1.2fr 0.8fr auto; gap:10px; margin-top:8px}
    .opt-row.undertone{grid-template-columns: 1.1fr 1fr 1.6fr 0.9fr auto;} /* label, value, desc, color, X */
    .opt-row.tones{grid-template-columns: 1.1fr 1fr 1.6fr 0.7fr auto;}    /* label, value, image, group, X */
    .opt-row.default{grid-template-columns: 1.1fr 1fr auto;}              /* label, value, X */
    .hr{height:1px;background:var(--line);margin:12px 0}
    label.small{font-size:12px;color:#374151;display:block;margin-bottom:6px}
    .pill{padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px}

    /* Password modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
    .overlay.show{display:flex}
    .modal{background:#fff;border-radius:16px;border:1px solid var(--line);padding:20px;min-width:300px;max-width:90vw}
    .modal h3{margin:0 0 10px}
  </style>
</head>
<body>

  <h1>Quiz Config Editor</h1>
  <div class="muted">Edit questions and combo rules. Click <b>Save</b> to publish.</div>

  <div class="section row">
    <button class="btn ok" id="addQ">+ Add Question</button>
    <button class="btn primary" id="saveAll">ðŸ’¾ Save</button>
    <span id="msg" class="muted"></span>
  </div>

  <div id="questions"></div>

  <div class="section">
    <h2>Combo Rules <span class="pill">match multiple answers â†’ recommend</span></h2>
    <div id="combos"></div>
    <div class="row" style="margin-top:10px">
      <button class="btn ok" id="addCombo">+ Add Combo Rule</button>
    </div>
  </div>

  <!-- Password popup -->
  <div id="pwOverlay" class="overlay">
    <div class="modal">
      <h3>Enter Admin Password</h3>
      <p class="muted" style="margin-top:-6px">Used for saving and loading your quiz config.</p>
      <div class="row">
        <input id="pwInput" type="password" placeholder="Admin password" style="flex:1;min-width:240px"/>
        <button id="pwGo" class="btn primary">Open editor</button>
      </div>
      <div id="pwErr" class="muted" style="color:#d32f2f;margin-top:6px;display:none">Wrong password. Try again.</div>
    </div>
  </div>

<script>
/* ========================
   Password handling (header)
======================== */
function getPW(){ return sessionStorage.getItem('quiz_admin_pw') || ''; }
function setPW(v){ sessionStorage.setItem('quiz_admin_pw', v || ''); }
function clearPW(){ sessionStorage.removeItem('quiz_admin_pw'); }

const overlay = document.getElementById('pwOverlay');
const pwInput = document.getElementById('pwInput');
const pwGo    = document.getElementById('pwGo');
const pwErr   = document.getElementById('pwErr');

function promptPW(showError=false){
  overlay.classList.add('show');
  pwErr.style.display = showError ? 'block' : 'none';
  pwInput.value = '';
  pwInput.focus();
}
pwGo.onclick = () => {
  const v = pwInput.value.trim();
  if(!v) return;
  setPW(v);
  overlay.classList.remove('show');
  loadData(true);
};

async function adminGET(url){
  const r = await fetch(url, { headers: { 'X-Admin-Password': getPW() } });
  if (r.status === 401) throw new Error('unauth');
  return r;
}
async function adminPUT(url, body){
  const r = await fetch(url, {
    method: 'PUT',
    headers: { 'Content-Type':'application/json', 'X-Admin-Password': getPW() },
    body: JSON.stringify(body)
  });
  if (r.status === 401) throw new Error('unauth');
  return r;
}

/* ========================
   UI helpers & state
======================== */
let config = { name:"", resultsTitle:"", questions:[], combos:[], rules:[] };

const el = sel => document.querySelector(sel);
const make = (tag, attrs={}, kids=[]) => {
  const d = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === 'class') d.className = v;
    else if (k === 'text') d.textContent = v;
    else d.setAttribute(k, v);
  }
  (Array.isArray(kids)?kids:[kids]).forEach(k => d.appendChild(typeof k==='string'?document.createTextNode(k):k));
  return d;
};

const msgEl = el('#msg');
function toast(t){ msgEl.textContent = t; setTimeout(()=>{ msgEl.textContent=''; }, 2500); }

/* ========================
   Normalization functions
   - Keep combo WHEN as an editable array in UI
   - Convert to object only on save
======================== */
function normalizeForEdit(cfg){
  (cfg.combos || []).forEach(c=>{
    if (!Array.isArray(c.__whenList)) {
      const obj = c.when || {};
      c.__whenList = Object.entries(obj).map(([key,val])=>({ key, val: String(val) }));
    }
  });
}
function cloneForSave(cfg){
  const out = JSON.parse(JSON.stringify(cfg));
  (out.combos || []).forEach(c=>{
    const list = Array.isArray(c.__whenList) ? c.__whenList : [];
    const obj = {};
    list.forEach(({key,val})=>{
      const k = (key||'').trim();
      if (!k) return;
      obj[k] = String(val ?? '');
    });
    c.when = obj;
    delete c.__whenList;
  });
  return out;
}

/* ========================
   Load & Save
======================== */
async function loadData(isRetry=false){
  try{
    const r = await adminGET('/apps/quiz/admin/config');
    config = await r.json();
    if (!config.questions) config.questions = [];
    if (!config.combos) config.combos = [];
    normalizeForEdit(config);
    renderQuestions();
    renderCombos();
    if (isRetry) toast('Unlocked');
  }catch(e){
    if (e.message === 'unauth'){
      promptPW(isRetry); // show error after a failed attempt
    } else {
      toast('Load failed');
    }
  }
}

async function saveAll(){
  try{
    const payload = cloneForSave(config);
    const r = await adminPUT('/apps/quiz/admin/config', payload);
    toast(r.ok ? 'Saved!' : 'Failed');
  }catch(e){
    if (e.message === 'unauth'){
      clearPW();
      promptPW(true);
    } else {
      toast('Save failed');
    }
  }
}

/* ========================
   Render: Questions
======================== */
function renderQuestions(){
  const wrap = el('#questions');
  wrap.innerHTML = '';
  config.questions.forEach((q, qi) => {
    const card = make('div', { class:'q-card' });

    // Header: id + layout
    const header = make('div', { class:'grid' }, [
      make('div', {}, [
        make('label', { class:'small', for:`qid-${qi}`, text:'Question ID:' }),
        make('input', { id:`qid-${qi}`, value:q.id||'', oninput: (e)=>{ q.id = e.target.value.trim(); }})
      ]),
      make('div', {}, [
        make('label', { class:'small', for:`lay-${qi}`, text:'Layout:' }),
        (()=>{
          const sel = make('select', { id:`lay-${qi}` });
          ['undertone','tone-faces','radios'].forEach(v=>{
            const opt = make('option', { value:v, text:v });
            if ((q.layout||'')===v) opt.selected = true;
            sel.appendChild(opt);
          });
          sel.onchange = ()=>{ q.layout = sel.value; renderQuestions(); };
          return sel;
        })()
      ])
    ]);
    card.appendChild(header);

    // Title
    card.appendChild(make('div', { class:'section' }, [
      make('label', { class:'small', for:`qt-${qi}`, text:'Title:' }),
      make('input', { id:`qt-${qi}`, value:q.title||'', oninput:(e)=>{ q.title=e.target.value; }})
    ]));

    // Options
    const optsWrap = make('div', { class:'section' });
    optsWrap.appendChild(make('div', { class:'hr' }));
    optsWrap.appendChild(make('div', { class:'row' }, [
      make('div', { class:'muted', text:'Options' })
    ]));

    const opts = q.options || (q.options = []);

    function rowUndertone(oi, opt){
      const row = make('div', { class:'opt-row undertone' });
      row.append(
        make('div', {}, [ make('label',{class:'small',text:'Label'}), make('input',{value:opt.label||'', oninput:e=>opt.label=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Value'}), make('input',{value:opt.value||'', oninput:e=>opt.value=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Desc'}),  make('input',{value:opt.desc||'', oninput:e=>opt.desc=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Color (optional)'}), make('input',{value:opt.color||'', oninput:e=>opt.color=e.target.value, placeholder:'#b8a6f3'}) ]),
        make('div', {}, [ make('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ opts.splice(oi,1); renderQuestions(); }}) ])
      );
      return row;
    }

    function rowToneFaces(oi, opt){
      const row = make('div', { class:'opt-row tones' });
      row.append(
        make('div', {}, [ make('label',{class:'small',text:'Label'}), make('input',{value:opt.label||'', oninput:e=>opt.label=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Value'}), make('input',{value:opt.value||'', oninput:e=>opt.value=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Image URL'}), make('input',{value:opt.image||'', oninput:e=>opt.image=e.target.value, placeholder:'https://...'}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Group (slider index)'}), make('input',{type:'number',value:(opt.group??0), oninput:e=>opt.group=Number(e.target.value)}) ]),
        make('div', {}, [ make('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ opts.splice(oi,1); renderQuestions(); }}) ])
      );
      return row;
    }

    function rowDefault(oi, opt){
      const row = make('div', { class:'opt-row default' });
      row.append(
        make('div', {}, [ make('label',{class:'small',text:'Label'}), make('input',{value:opt.label||'', oninput:e=>opt.label=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Value'}), make('input',{value:opt.value||'', oninput:e=>opt.value=e.target.value}) ]),
        make('div', {}, [ make('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ opts.splice(oi,1); renderQuestions(); }}) ])
      );
      return row;
    }

    opts.forEach((opt, oi) => {
      if (q.layout === 'undertone') optsWrap.appendChild(rowUndertone(oi,opt));
      else if (q.layout === 'tone-faces') optsWrap.appendChild(rowToneFaces(oi,opt));
      else optsWrap.appendChild(rowDefault(oi,opt));
    });

    const addOptBtn = make('button', { class:'btn small', text:'+ Add Option' });
    addOptBtn.onclick = ()=>{
      if (q.layout === 'undertone') opts.push({ label:'', value:'', desc:'', color:'' });
      else if (q.layout === 'tone-faces') opts.push({ label:'', value:'', image:'', group:0 });
      else opts.push({ label:'', value:'' });
      renderQuestions();
    };
    optsWrap.appendChild(make('div',{class:'row',style:'margin-top:8px'},[addOptBtn]));
    card.appendChild(optsWrap);

    // Delete question
    card.appendChild(make('div',{class:'row',style:'justify-content:flex-end'},[
      make('button',{class:'btn bad',text:'Delete Question',onclick:()=>{ config.questions.splice(qi,1); renderQuestions(); }})
    ]));

    wrap.appendChild(card);
  });
}

/* ========================
   Render: Combos (with array editor)
======================== */
function renderCombos(){
  const wrap = el('#combos');
  wrap.innerHTML = '';
  config.combos.forEach((c, ci) => {
    const card = make('div',{class:'q-card'});

    // ensure list exists
    if (!Array.isArray(c.__whenList)) c.__whenList = [];

    // CONDITIONS
    const whenWrap = make('div');
    c.__whenList.forEach((pair, idx) => {
      const row = make('div',{class:'grid-3',style:'margin-bottom:8px'});
      const keyInput = make('input',{value:pair.key||'', placeholder:'Question ID'});
      const valInput = make('input',{value:pair.val||'', placeholder:'Value'});
      const delBtn   = make('button',{class:'btn small bad',text:'âœ•'});

      keyInput.oninput = e => { pair.key = e.target.value; };
      valInput.oninput = e => { pair.val = e.target.value; };
      delBtn.onclick   = () => { c.__whenList.splice(idx,1); renderCombos(); };

      row.append(
        make('div',{},[ make('label',{class:'small',text:'Question ID'}), keyInput ]),
        make('div',{},[ make('label',{class:'small',text:'Value'}), valInput ]),
        make('div',{},[ make('label',{class:'small',text:'Remove'}), delBtn ])
      );
      whenWrap.appendChild(row);
    });

    const addCond = make('button',{class:'btn small',text:'+ Add Condition',onclick:()=>{ c.__whenList.push({key:'',val:''}); renderCombos(); }});

    // RECOMMEND handles
    const rec = Array.isArray(c.recommend) ? c.recommend : (c.recommend = []);
    const recInput = make('input',{
      value: rec.join(','),
      placeholder:'Comma separated product handles'
    });
    recInput.oninput = e => { c.recommend = e.target.value.split(',').map(s=>s.trim()).filter(Boolean); };

    // COMPOSE
    card.append(
      make('div',{class:'muted',text:'When ALL conditions match:'}),
      whenWrap,
      addCond,
      make('div',{class:'hr'}),
      make('div',{},[ make('label',{class:'small',text:'Recommend handles'}), recInput ]),
      make('div',{class:'row',style:'justify-content:flex-end;margin-top:8px'},[
        make('button',{class:'btn bad',text:'Delete Combo',onclick:()=>{ config.combos.splice(ci,1); renderCombos(); }})
      ])
    );
    wrap.appendChild(card);
  });
}

/* ========================
   Buttons & boot
======================== */
document.getElementById('addQ').onclick = ()=>{
  config.questions.push({ id:'q'+(config.questions.length+1), layout:'undertone', title:'', options:[] });
  renderQuestions();
};
document.getElementById('addCombo').onclick = ()=>{ config.combos.push({ __whenList:[], recommend:[] }); renderCombos(); };
document.getElementById('saveAll').onclick = saveAll;

// Start: if password stored, try; else popup
(function boot(){
  if (getPW()) loadData(); else promptPW(false);
})();
</script>
</body>
</html>
