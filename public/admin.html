<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Quiz Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --blue:#1976d2; --green:#388e3c; --red:#d32f2f; --bg:#fafafa; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
         padding:20px;max-width:1200px;margin:auto;background:#fff;color:#111}
    h1{margin:0 0 12px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.ok{background:var(--green);border-color:var(--green);color:#fff}
    .btn.bad{background:var(--red);border-color:var(--red);color:#fff}
    .btn.small{padding:6px 9px;font-size:12px}
    input,select,textarea{padding:10px;border:1px solid var(--border);border-radius:10px;min-width:0;width:100%}
    .section{margin-top:22px}
    .card{border:1px solid var(--border);border-radius:12px;padding:14px;margin:14px 0;background:var(--bg)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .opt-row{display:grid;gap:10px;margin-top:8px}
    .opt-row.undertone{grid-template-columns:1.1fr 1fr 1.6fr auto}
    .opt-row.tones{grid-template-columns:1.1fr 1fr 1.6fr .8fr auto}
    .opt-row.default{grid-template-columns:1.1fr 1fr auto}
    label.small{font-size:12px;color:#374151;display:block;margin-bottom:6px}
    .hr{height:1px;background:var(--border);margin:12px 0}
    /* Password gate */
    .gate{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center}
    .gate.hidden{display:none}
    .panel{background:#fff;border-radius:12px;padding:20px;width:min(520px,92vw);box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .err{color:var(--red);min-height:1em;margin-top:8px}
  </style>
</head>
<body>

  <h1>Quiz Config Editor</h1>
  <div class="muted">Edit questions and combo rules. Click <b>Save</b> to publish.</div>

  <div class="row" style="margin:12px 0 18px">
    <button class="btn" id="reloadBtn">â†» Reload</button>
    <button class="btn primary" id="saveBtn">ðŸ’¾ Save All Changes</button>
    <span id="flash" class="muted"></span>
  </div>

  <h2>Questions</h2>
  <div id="questions"></div>
  <button class="btn ok" id="addQ">+ Add Question</button>

  <div class="section">
    <h2>Combo Rules <span class="muted">(match multiple answers â†’ recommend handles)</span></h2>
    <div id="combos"></div>
    <button class="btn ok" id="addCombo" style="margin-top:8px">+ Add Combo Rule</button>
  </div>

  <!-- Password overlay -->
  <div class="gate hidden" id="gate">
    <div class="panel">
      <h3>Enter Admin Password</h3>
      <p class="muted">Config API is protected. Enter the password to load/save.</p>
      <p>Use Admin Password : quiz12345</p>
      <div class="row">
        <input id="pw" type="password" placeholder="Admin password" style="flex:1">
        <button class="btn primary" id="loginBtn">Open editor</button>
      </div>
      <div id="err" class="err"></div>
    </div>
  </div>

<script>
/* ---------------- state + helpers ---------------- */
let config = { name:"", resultsTitle:"", questions:[], combos:[], rules:[] };
const qs = new URL(location.href).searchParams;
const PW_KEY = 'quiz_admin_pw';

const $ = sel => document.querySelector(sel);
const el = (tag, attrs={}, kids=[]) => {
  const d = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k==='class') d.className = v;
    else if (k==='text') d.textContent = v;
    else d.setAttribute(k, v);
  }
  (Array.isArray(kids)?kids:[kids]).forEach(k => d.appendChild(typeof k==='string'?document.createTextNode(k):k));
  return d;
};

function getPassword(){
  const p = qs.get('p');
  if (p){ localStorage.setItem(PW_KEY, p); return p; }
  return localStorage.getItem(PW_KEY) || '';
}
function setPassword(p){ localStorage.setItem(PW_KEY, p || ''); }

async function apiGet(){
  const pw = getPassword();
  const r = await fetch(`/apps/quiz/admin/config?p=${encodeURIComponent(pw)}`);
  if (r.status === 401) throw new Error('unauthorized');
  return r.json();
}
async function apiPut(body){
  const pw = getPassword();
  const r = await fetch(`/apps/quiz/admin/config?p=${encodeURIComponent(pw)}`,{
    method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
  });
  if (r.status === 401) throw new Error('unauthorized');
  return r.json();
}

function flash(msg, ok=true){
  const f = $('#flash'); f.textContent = msg; f.style.color = ok ? '#2e7d32' : '#d32f2f';
  setTimeout(()=>{ f.textContent=''; }, 2500);
}

/* ---------------- load/save ---------------- */
async function loadData(){
  try{
    const data = await apiGet();
    config = data || {};
    if(!Array.isArray(config.questions)) config.questions=[];
    if(!Array.isArray(config.combos)) config.combos=[];
    if(!Array.isArray(config.rules)) config.rules=[];
    renderQuestions(); renderCombos();
    $('#gate').classList.add('hidden');
  }catch(e){
    if(e.message==='unauthorized'){
      $('#gate').classList.remove('hidden');
      $('#err').textContent = 'Password required or incorrect.';
      $('#pw').focus();
    }else{
      flash('Failed to load', false); console.error(e);
    }
  }
}
async function saveData(){
  try{
    await apiPut(config);
    flash('Saved!');
  }catch(e){
    if(e.message==='unauthorized'){
      $('#gate').classList.remove('hidden');
      $('#err').textContent = 'Password required or incorrect.';
    }else{
      flash('Save failed', false); console.error(e);
    }
  }
}

/* ---------------- questions UI ---------------- */
function renderQuestions(){
  const wrap = $('#questions'); wrap.innerHTML='';
  (config.questions||[]).forEach((q, qi)=>{
    const card = el('div',{class:'card'});

    // Header
    card.appendChild(
      el('div',{class:'grid2'},[
        el('div',{},[
          el('label',{class:'small',text:'Question ID:'}),
          el('input',{value:q.id||'', oninput:(e)=>{ q.id = e.target.value.trim(); }})
        ]),
        el('div',{},[
          el('label',{class:'small',text:'Layout:'}),
          (()=>{ const s=el('select');
            ['undertone','tone-faces','radios'].forEach(v=>{
              const o=el('option',{value:v,text:v}); if((q.layout||'')===v) o.selected=true; s.appendChild(o);
            });
            s.onchange=()=>{ q.layout = s.value; renderQuestions(); };
            return s;
          })()
        ])
      ])
    );

    // Title
    card.appendChild(
      el('div',{class:'section'},[
        el('label',{class:'small',text:'Title:'}),
        el('input',{value:q.title||'', oninput:(e)=>{ q.title=e.target.value; }})
      ])
    );

    // Options
    const opts = q.options || (q.options=[]);
    const optsWrap = el('div',{class:'section'});
    optsWrap.appendChild(el('div',{class:'hr'}));
    optsWrap.appendChild(el('div',{class:'muted',text:'Options'}));

    // rows by layout
    function rowUndertone(oi,opt){
      const r=el('div',{class:'opt-row undertone'});
      r.append(
        el('div',{},[el('label',{class:'small',text:'Label'}), el('input',{value:opt.label||'', oninput:e=>opt.label=e.target.value})]),
        el('div',{},[el('label',{class:'small',text:'Value'}), el('input',{value:opt.value||'', oninput:e=>opt.value=e.target.value})]),
        el('div',{},[el('label',{class:'small',text:'Desc'}),  el('input',{value:opt.desc||'',  oninput:e=>opt.desc = e.target.value})]),
        el('div',{},[el('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ opts.splice(oi,1); renderQuestions(); }})])
      ); return r;
    }
    function rowToneFaces(oi,opt){
      const r=el('div',{class:'opt-row tones'});
      r.append(
        el('div',{},[el('label',{class:'small',text:'Label'}), el('input',{value:opt.label||'', oninput:e=>opt.label=e.target.value})]),
        el('div',{},[el('label',{class:'small',text:'Value'}), el('input',{value:opt.value||'', oninput:e=>opt.value=e.target.value})]),
        el('div',{},[el('label',{class:'small',text:'Image URL'}), el('input',{value:opt.image||'', oninput:e=>opt.image=e.target.value, placeholder:'https://...'})]),
        el('div',{},[el('label',{class:'small',text:'Group (slider index)'}), el('input',{type:'number',value:(opt.group??0), oninput:e=>opt.group=Number(e.target.value)})]),
        el('div',{},[el('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ opts.splice(oi,1); renderQuestions(); }})])
      ); return r;
    }
    function rowDefault(oi,opt){
      const r=el('div',{class:'opt-row default'});
      r.append(
        el('div',{},[el('label',{class:'small',text:'Label'}), el('input',{value:opt.label||'', oninput:e=>opt.label=e.target.value})]),
        el('div',{},[el('label',{class:'small',text:'Value'}), el('input',{value:opt.value||'', oninput:e=>opt.value=e.target.value})]),
        el('div',{},[el('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ opts.splice(oi,1); renderQuestions(); }})])
      ); return r;
    }

    opts.forEach((opt,oi)=>{
      if(q.layout==='undertone') optsWrap.appendChild(rowUndertone(oi,opt));
      else if(q.layout==='tone-faces') optsWrap.appendChild(rowToneFaces(oi,opt));
      else optsWrap.appendChild(rowDefault(oi,opt));
    });

    const addBtn = el('button',{class:'btn small',text:'+ Add Option',onclick:()=>{
      if(q.layout==='undertone') opts.push({label:'',value:'',desc:''});
      else if(q.layout==='tone-faces') opts.push({label:'',value:'',image:'',group:0});
      else opts.push({label:'',value:''});
      renderQuestions();
    }});
    optsWrap.appendChild(el('div',{style:'margin-top:8px'},[addBtn]));
    card.appendChild(optsWrap);

    // Delete question
    card.appendChild(el('div',{class:'row',style:'justify-content:flex-end'},[
      el('button',{class:'btn bad',text:'Delete Question',onclick:()=>{ config.questions.splice(qi,1); renderQuestions(); }})
    ]));

    wrap.appendChild(card);
  });
}

/* ---------------- combos UI ---------------- */
function renderCombos(){
  const wrap = $('#combos'); wrap.innerHTML='';
  (config.combos||[]).forEach((c,ci)=>{
    const card = el('div',{class:'card'});
    const when = c.when || (c.when={});
    const rec  = Array.isArray(c.recommend)?c.recommend:(c.recommend=[]);

    const whenWrap = el('div');
    Object.entries(when).forEach(([k,v])=>{
      whenWrap.appendChild(
        el('div',{class:'row',style:'gap:10px;margin-bottom:6px'},[
          el('input',{placeholder:'Question ID',value:k,oninput:(e)=>{const nv=e.target.value.trim(); if(!nv) return; delete when[k]; when[nv]=v; renderCombos();}}),
          el('input',{placeholder:'Value',value:v,oninput:(e)=>{ when[k]=e.target.value; }}),
          el('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ delete when[k]; renderCombos(); }})
        ])
      );
    });

    card.append(
      el('div',{class:'muted',text:'When ALL conditions match:'}),
      whenWrap,
      el('button',{class:'btn small',text:'+ Add Condition',onclick:()=>{ when['questionId']='value'; renderCombos(); }}),
      el('div',{class:'hr'}),
      el('div',{},[
        el('label',{class:'small',text:'Recommend handles (comma separated)'}),
        el('input',{value:rec.join(','),oninput:(e)=>{ c.recommend = e.target.value.split(',').map(s=>s.trim()).filter(Boolean); }})
      ]),
      el('div',{class:'row',style:'justify-content:flex-end;margin-top:8px'},[
        el('button',{class:'btn bad',text:'Delete Combo',onclick:()=>{ config.combos.splice(ci,1); renderCombos(); }})
      ])
    );

    wrap.appendChild(card);
  });
}

/* ---------------- events ---------------- */
$('#addQ').onclick = ()=>{ (config.questions||[]).push({id:'q'+((config.questions?.length||0)+1),layout:'undertone',title:'',options:[]}); renderQuestions(); };
$('#addCombo').onclick = ()=>{ (config.combos||[]).push({when:{},recommend:[]}); renderCombos(); };
$('#reloadBtn').onclick = loadData;
$('#saveBtn').onclick = saveData;

$('#loginBtn').onclick = async ()=>{
  const pw = $('#pw').value.trim();
  if(!pw){ $('#err').textContent='Password is required.'; return; }
  setPassword(pw);
  $('#err').textContent='';
  await loadData();
};

/* ---------------- bootstrap ---------------- */
loadData();
</script>
</body>
</html>
