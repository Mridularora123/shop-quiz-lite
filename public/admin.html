<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Quiz Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#fff; --muted:#6b7280; --line:#e5e7eb;
      --brand:#7a1d3c; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body { font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
           padding: 20px; max-width: 1200px; margin: auto; color:#111; background:#fff; }
    h1{margin:0 0 14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .btn{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
    .btn.small{padding:6px 9px;font-size:12px}
    input,select,textarea{
      padding:10px;border:1px solid var(--line);border-radius:10px;min-width:0;
      width:100%;
    }
    .section{margin-top:22px}
    .q-card{border:1px solid var(--line);border-radius:12px;padding:14px 14px 10px;margin:14px 0;background:#fafafa}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .opt-row{display:grid;grid-template-columns: 1.1fr 1fr 1.2fr 0.8fr auto; gap:10px; margin-top:8px}
    .opt-row.undertone{grid-template-columns: 1.1fr 1fr 1.6fr 0.9fr auto;}
    .opt-row.tones{grid-template-columns: 1.1fr 1fr 1.6fr 0.7fr auto;}
    .opt-row.default{grid-template-columns: 1.1fr 1fr auto;}
    .hr{height:1px;background:var(--line);margin:12px 0}
    label.small{font-size:12px;color:#374151;display:block;margin-bottom:6px}
    .pill{padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px}
  </style>
</head>
<body>

  <h1>Quiz Config Editor</h1>
  <div class="muted">Edit questions and combo rules. Click <b>Save</b> to publish.</div>

  <div class="section row">
    <button class="btn ok" id="addQ">+ Add Question</button>
    <button class="btn primary" id="saveAll">ðŸ’¾ Save</button>
    <span id="msg" class="muted"></span>
  </div>

  <div id="questions"></div>

  <div class="section">
    <h2>Combo Rules <span class="pill">match multiple answers â†’ recommend</span></h2>
    <div id="combos"></div>
    <div class="row" style="margin-top:10px">
      <button class="btn ok" id="addCombo">+ Add Combo Rule</button>
    </div>
  </div>

<script>
let config = { name:"", resultsTitle:"", questions:[], combos:[], rules:[] };
const p = new URL(location).searchParams.get("p") || "";

const el = sel => document.querySelector(sel);
const make = (tag, attrs={}, kids=[]) => {
  const d = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === 'class') d.className = v;
    else if (k === 'text') d.textContent = v;
    else d.setAttribute(k, v);
  }
  (Array.isArray(kids)?kids:[kids]).forEach(k => d.appendChild(typeof k==='string'?document.createTextNode(k):k));
  return d;
};

async function loadData(){
  const r = await fetch(`/apps/quiz/admin/config?p=${encodeURIComponent(p)}`);
  config = await r.json();
  if (!config.questions) config.questions = [];
  if (!config.combos) config.combos = [];
  renderQuestions();
  renderCombos();
}

function renderQuestions(){
  const wrap = el('#questions');
  wrap.innerHTML = '';
  config.questions.forEach((q, qi) => {
    const card = make('div', { class:'q-card' });

    // Header row: id + layout + delete
    const header = make('div', { class:'grid' }, [
      make('div', {}, [
        make('label', { class:'small', for:`qid-${qi}`, text:'Question ID:' }),
        make('input', { id:`qid-${qi}`, value:q.id||'', oninput: (e)=>{ q.id = e.target.value.trim(); }})
      ]),
      make('div', {}, [
        make('label', { class:'small', for:`lay-${qi}`, text:'Layout:' }),
        (()=>{
          const sel = make('select', { id:`lay-${qi}` });
          ['undertone','tone-faces','radios'].forEach(v=>{
            const opt = make('option', { value:v, text:v });
            if ((q.layout||'')===v) opt.selected = true;
            sel.appendChild(opt);
          });
          sel.onchange = ()=>{ q.layout = sel.value; renderQuestions(); };
          return sel;
        })()
      ])
    ]);
    card.appendChild(header);

    // Title
    card.appendChild(make('div', { class:'section' }, [
      make('label', { class:'small', for:`qt-${qi}`, text:'Title:' }),
      make('input', { id:`qt-${qi}`, value:q.title||'', oninput:(e)=>{ q.title=e.target.value; }})
    ]));

    // Options block by layout
    const optsWrap = make('div', { class:'section' });
    optsWrap.appendChild(make('div', { class:'hr' }));
    optsWrap.appendChild(make('div', { class:'row' }, [
      make('div', { class:'muted', text:'Options' })
    ]));

    const opts = q.options || (q.options = []);

    // Row builder per layout
    function rowUndertone(oi, opt){
      const row = make('div', { class:'opt-row undertone' });
      row.append(
        make('div', {}, [ make('label',{class:'small',text:'Label'}), make('input',{value:opt.label||'', oninput:e=>opt.label=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Value'}), make('input',{value:opt.value||'', oninput:e=>opt.value=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Desc'}),  make('input',{value:opt.desc||'', oninput:e=>opt.desc=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Color (optional)'}), make('input',{value:opt.color||'', oninput:e=>opt.color=e.target.value, placeholder:'#b8a6f3'}) ]),
        make('div', {}, [ make('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ opts.splice(oi,1); renderQuestions(); }}) ])
      );
      return row;
    }

    function rowToneFaces(oi, opt){
      const row = make('div', { class:'opt-row tones' });
      row.append(
        make('div', {}, [ make('label',{class:'small',text:'Label'}), make('input',{value:opt.label||'', oninput:e=>opt.label=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Value'}), make('input',{value:opt.value||'', oninput:e=>opt.value=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Image URL'}), make('input',{value:opt.image||'', oninput:e=>opt.image=e.target.value, placeholder:'https://...'}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Group (slider index)'}), make('input',{type:'number',value:(opt.group??0), oninput:e=>opt.group=Number(e.target.value)}) ]),
        make('div', {}, [ make('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ opts.splice(oi,1); renderQuestions(); }}) ])
      );
      return row;
    }

    function rowDefault(oi, opt){
      const row = make('div', { class:'opt-row default' });
      row.append(
        make('div', {}, [ make('label',{class:'small',text:'Label'}), make('input',{value:opt.label||'', oninput:e=>opt.label=e.target.value}) ]),
        make('div', {}, [ make('label',{class:'small',text:'Value'}), make('input',{value:opt.value||'', oninput:e=>opt.value=e.target.value}) ]),
        make('div', {}, [ make('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ opts.splice(oi,1); renderQuestions(); }}) ])
      );
      return row;
    }

    // Render existing options
    opts.forEach((opt, oi) => {
      if (q.layout === 'undertone') optsWrap.appendChild(rowUndertone(oi,opt));
      else if (q.layout === 'tone-faces') optsWrap.appendChild(rowToneFaces(oi,opt));
      else optsWrap.appendChild(rowDefault(oi,opt));
    });

    // Add option button sets sensible defaults per layout
    const addOptBtn = make('button', { class:'btn small', text:'+ Add Option' });
    addOptBtn.onclick = ()=>{
      if (q.layout === 'undertone') opts.push({ label:'', value:'', desc:'', color:'' });
      else if (q.layout === 'tone-faces') opts.push({ label:'', value:'', image:'', group:0 });
      else opts.push({ label:'', value:'' });
      renderQuestions();
    };
    optsWrap.appendChild(make('div',{class:'row',style:'margin-top:8px'},[addOptBtn]));
    card.appendChild(optsWrap);

    // Delete question
    card.appendChild(make('div',{class:'row',style:'justify-content:flex-end'},[
      make('button',{class:'btn bad',text:'Delete Question',onclick:()=>{ config.questions.splice(qi,1); renderQuestions(); }})
    ]));

    wrap.appendChild(card);
  });
}

// COMBOS
function renderCombos(){
  const wrap = el('#combos');
  wrap.innerHTML = '';
  config.combos.forEach((c, ci) => {
    const card = make('div',{class:'q-card'});
    const when = c.when || (c.when = {});
    const rec  = Array.isArray(c.recommend) ? c.recommend : (c.recommend = []);

    const whenWrap = make('div');
    for (const [k,v] of Object.entries(when)){
      whenWrap.appendChild(
        make('div',{class:'grid-3',style:'margin-bottom:8px'},[
          make('div',{},[ make('label',{class:'small',text:'Question ID'}), make('input',{value:k,oninput:e=>{ const nv=e.target.value.trim(); delete when[k]; when[nv]=v; renderCombos(); }}) ]),
          make('div',{},[ make('label',{class:'small',text:'Value'}), make('input',{value:v,oninput:e=>{ when[k]=e.target.value; }}) ]),
          make('div',{},[ make('label',{class:'small',text:'Remove'}), make('button',{class:'btn small bad',text:'âœ•',onclick:()=>{ delete when[k]; renderCombos(); }}) ])
        ])
      );
    }

    const addCond = make('button',{class:'btn small',text:'+ Add Condition',onclick:()=>{ when['questionId']='value'; renderCombos(); }});

    const recInput = make('input',{ value: rec.join(','), oninput:e=>{ c.recommend = e.target.value.split(',').map(s=>s.trim()).filter(Boolean); } , placeholder:'Comma separated product handles' });

    card.append(
      make('div',{class:'muted',text:'When ALL conditions match:'}),
      whenWrap,
      addCond,
      make('div',{class:'hr'}),
      make('div',{},[ make('label',{class:'small',text:'Recommend handles'}), recInput ]),
      make('div',{class:'row',style:'justify-content:flex-end;margin-top:8px'},[
        make('button',{class:'btn bad',text:'Delete Combo',onclick:()=>{ config.combos.splice(ci,1); renderCombos(); }})
      ])
    );
    wrap.appendChild(card);
  });
}

// BUTTONS
el('#addQ').onclick = ()=>{
  config.questions.push({ id:'q'+(config.questions.length+1), layout:'undertone', title:'', options:[] });
  renderQuestions();
};
el('#addCombo').onclick = ()=>{ config.combos.push({ when:{}, recommend:[] }); renderCombos(); };

el('#saveAll').onclick = async ()=>{
  const r = await fetch(`/apps/quiz/admin/config?p=${encodeURIComponent(p)}`,{
    method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(config)
  });
  el('#msg').textContent = r.ok ? 'Saved!' : 'Failed';
  setTimeout(()=>{ el('#msg').textContent=''; }, 2500);
};

loadData();
</script>
</body>
</html>
